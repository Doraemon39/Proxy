设置防火墙，仅允许国内IP入站，屏蔽国外

1.准备工作

```
sudo apt install -y nftables curl cron
```

```
sudo systemctl enable --now nftables
```

```
sudo nft list ruleset > /etc/nftables.rules.bak
```

```
sudo mkdir -p /etc/nftables/ipset
```

```
sudo chmod 700 /etc/nftables/ipset
```

2.设置防火墙配置

```
nano /etc/nftables.conf
```

```
#!/usr/sbin/nft -f

flush ruleset

table inet filter {
    # 先引入持久化的集合文件（内部仅包含 set 定义）
    include "/etc/nftables/ipset/cn-set.nft"
    include "/etc/nftables/ipset/cn6-set.nft"

    chain input {
        type filter hook input priority filter;
        policy drop;

        # 丢弃无效状态报文（安全增强）
        ct state invalid drop

        iif "lo" accept
        ct state { established, related } accept

        # 仅向中国 IPv4 放行端口
        tcp dport { 80, 443, 22 } ip  saddr @china_ips  accept
        # 新增：仅向中国 IPv6 放行端口
        tcp dport { 80, 443, 22 } ip6 saddr @china6_ips accept

        # 可选：如需支持 HTTP/3/QUIC，取消下面两行注释
        # udp dport 443 ip  saddr @china_ips  accept
        # udp dport 443 ip6 saddr @china6_ips accept

        # ICMPv4/ICMPv6 必要类型（保留）
        icmp type {
            destination-unreachable, time-exceeded, parameter-problem
        } accept

        # 如需允许 IPv4 ping，可按需开启：
        # icmp type echo-request accept

        icmpv6 type {
            destination-unreachable, packet-too-big, time-exceeded,
            parameter-problem, nd-neighbor-solicit, nd-neighbor-advert,
            nd-router-advert, nd-router-solicit
        } accept

        # 如需允许 IPv6 ping，可按需开启：
        # icmpv6 type echo-request accept
    }

    chain forward { type filter hook forward priority filter; policy drop; }
    chain output  { type filter hook output  priority filter; policy accept; }
}

```

3.创建脚本

```
sudo nano /usr/local/sbin/update-cn-ips.sh
```

```
#!/bin/bash
set -e

# --- 配置参数 ---
PRIMARY_URL="https://www.ipdeny.com/ipblocks/data/countries/cn.zone"
PERSISTENT_SET_FILE="/etc/nftables/ipset/cn-set.nft"
TABLE="inet filter"
SET_NAME="china_ips"

# --- 安全临时目录 ---
TMP_DIR=$(mktemp -d)
trap 'rm -rf "$TMP_DIR"' EXIT

RAW_IPS_FILE="$TMP_DIR/cn.zone"
NFT_UPDATE_FILE="$TMP_DIR/update.nft"
SORTED_IPS_FILE="$TMP_DIR/sorted.zone"

# --- 增强验证函数（纯awk实现，兼容性更好） ---
validate_ips() {
    awk -F/ 'NF!=2{e=1}
    NF==2{
        split($1,a,".")
        if(length(a)!=4) e=1
        for(i=1;i<=4;i++) if(a[i] !~ /^[0-9]+$/ || a[i]<0 || a[i]>255) e=1
        if($2 !~ /^(3[0-2]|[12][0-9]|[1-9])$/) e=1
    } END{exit e}' "$1" || { echo "错误：IPv4 CIDR 校验失败" >&2; exit 1; }
}

# --- 确保主集合存在 ---
ensure_set_exists() {
    if ! sudo nft list set $TABLE $SET_NAME &>/dev/null; then
        echo "创建缺失的主集合..."
        sudo nft add set $TABLE $SET_NAME { type ipv4_addr\; flags interval\; auto-merge\; }
    fi
}

# --- 主流程 ---
echo "=> [1/4] 下载中国IP列表..."
if ! curl -sSf --connect-timeout 30 -o "$RAW_IPS_FILE" "$PRIMARY_URL"; then
    echo "主源失败，检查主源地址是否存在..." >&2
    exit 1
fi

ip_count=$(grep -c '.' "$RAW_IPS_FILE")
echo "下载成功，记录数: $ip_count"
validate_ips "$RAW_IPS_FILE"
sort -Vu "$RAW_IPS_FILE" > "$SORTED_IPS_FILE"  # 排序+去重以满足interval标志

ensure_set_exists

echo "=> [2/4] 准备安全更新..."
{
    # 生成逗号分隔的IP列表（末尾无逗号）
    awk '{printf "    %s,\n", $0}' "$SORTED_IPS_FILE" | sed '$ s/,$//' > "$TMP_DIR/ip-list.nft"

    cat <<EOF
# === 安全更新流程 ===
# 1. 清空现有集合内容
flush set $TABLE $SET_NAME

# 2. 原子加载新IP列表
add element $TABLE $SET_NAME {
$(cat "$TMP_DIR/ip-list.nft")
}
EOF
} > "$NFT_UPDATE_FILE"

echo "=> [3/4] 执行安全更新（预检语法）..."
sudo nft -c -f "$NFT_UPDATE_FILE" || {
    echo "❌ 预检失败！请检查：sudo nft -c -f $NFT_UPDATE_FILE" >&2
    exit 1
}

sudo nft -f "$NFT_UPDATE_FILE" || {
    echo "❌ 更新失败！错误信息已输出" >&2
    exit 1
}

echo "=> [4/4] 创建持久化文件（仅包含 set 定义）..."
{
    echo "set $SET_NAME {"
    echo "  type ipv4_addr"
    echo "  flags interval"
    echo "  auto-merge"
    echo "  elements = {"
    cat "$TMP_DIR/ip-list.nft"
    echo "  }"
    echo "}"
} > "$TMP_DIR/cn-set.nft"

sudo install -m 0600 -o root -g root "$TMP_DIR/cn-set.nft" "$PERSISTENT_SET_FILE"

echo "✅ 更新成功！处理 ${ip_count} 条记录，时间: $(date)"
```

```
sudo chmod 755 /usr/local/sbin/update-cn-ips.sh
```

4.首次允许脚本 看是否正常

```
sudo /usr/local/sbin/update-cn-ips.sh
```

5.创建脚本

```
sudo nano /usr/local/sbin/update-cn6-ips.sh
```

```
#!/bin/bash
set -e

# --- 配置参数（IPv6） ---
PRIMARY_URL="https://www.ipdeny.com/ipv6/ipaddresses/aggregated/cn-aggregated.zone"
PERSISTENT_SET_FILE="/etc/nftables/ipset/cn6-set.nft"
TABLE="inet filter"
SET_NAME="china6_ips"

# --- 安全临时目录 ---
TMP_DIR=$(mktemp -d)
trap 'rm -rf "$TMP_DIR"' EXIT

RAW_IPS_FILE="$TMP_DIR/cn6.zone"
SORTED_IPS_FILE="$TMP_DIR/sorted6.zone"
NFT_UPDATE_FILE="$TMP_DIR/update6.nft"

# --- 增强校验：限制掩码在 0–128 范围内 ---
validate_ips6() {
    if ! grep -qiE '^[0-9a-f:]+/(12[0-8]|1[01][0-9]|[1-9]?[0-9])$' "$1"; then
        echo "错误：文件中存在非法 IPv6 CIDR（掩码需在 0-128 范围）" >&2
        exit 1
    fi
}

# --- 确保 IPv6 集合存在 ---
ensure_set_exists6() {
    if ! sudo nft list set "$TABLE" "$SET_NAME" &>/dev/null; then
        echo "创建缺失的 IPv6 集合: $SET_NAME ..."
        sudo nft add set "$TABLE" "$SET_NAME" { type ipv6_addr\; flags interval\; auto-merge\; }
    fi
}

echo "=> [1/4] 下载中国 IPv6 列表..."
if ! curl -sSf --connect-timeout 30 -o "$RAW_IPS_FILE" "$PRIMARY_URL"; then
    echo "下载失败，检查 URL 或网络连接..." >&2
    exit 1
fi

ip_count=$(grep -c . "$RAW_IPS_FILE")
echo "下载成功，记录数: $ip_count"

# IPv6 列表通常已聚合；为满足 interval 标志，做稳定排序
sort -u "$RAW_IPS_FILE" > "$SORTED_IPS_FILE"
validate_ips6 "$SORTED_IPS_FILE"

ensure_set_exists6

echo "=> [2/4] 生成原子更新文件..."
# 生成逗号分隔列表（末尾无逗号）
awk '{printf "    %s,\n", $0}' "$SORTED_IPS_FILE" | sed '$ s/,$//' > "$TMP_DIR/ip6-list.nft"

cat > "$NFT_UPDATE_FILE" <<'EOF'
# === 安全更新流程（IPv6） ===
# 1. 清空现有集合内容
flush set inet filter china6_ips

# 2. 一次性加载新列表
add element inet filter china6_ips {
EOF

cat "$TMP_DIR/ip6-list.nft" >> "$NFT_UPDATE_FILE"
echo "}" >> "$NFT_UPDATE_FILE"

echo "=> [3/4] 预检并应用..."
sudo nft -c -f "$NFT_UPDATE_FILE" || {
    echo "❌ 预检失败！请检查：sudo nft -c -f $NFT_UPDATE_FILE" >&2
    exit 1
}

sudo nft -f "$NFT_UPDATE_FILE" || {
    echo "❌ 更新失败！错误信息已输出" >&2
    exit 1
}

echo "=> [4/4] 写入持久化文件（仅包含 set 定义）..."
{
  echo "set $SET_NAME {"
  echo "  type ipv6_addr"
  echo "  flags interval"
  echo "  auto-merge"
  echo "  elements = {"
  cat "$TMP_DIR/ip6-list.nft"
  echo "  }"
  echo "}"
} > "$TMP_DIR/cn6-set.nft"

sudo install -m 0600 -o root -g root "$TMP_DIR/cn6-set.nft" "$PERSISTENT_SET_FILE"
echo "✅ IPv6 更新成功！处理 ${ip_count} 条记录，时间: $(date)"
```

```
sudo chmod 755 /usr/local/sbin/update-cn6-ips.sh
```

```
sudo /usr/local/sbin/update-cn6-ips.sh
```

6.加载配置

```
sudo systemctl restart nftables.service
```

7.设置设置自动更新

```
sudo crontab -e
```

```
选择nano，然后在下面添加：
```

```
0 4 * * * /usr/local/sbin/update-cn-ips.sh  > /dev/null 2>&1
0 5 * * * /usr/local/sbin/update-cn6-ips.sh > /dev/null 2>&1
```

```
sudo crontab -l
查看已添加的cron任务
tail -f /var/log/syslog | grep cron
监视日志
```

